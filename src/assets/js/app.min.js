// useColorAdmin.js
import { onMounted } from 'vue'
/*import 'animate.css'*/

export function useColorAdmin() {

	const setHomeHeight = () => {
		const home = document.getElementById('home')
		if (home) {
			home.style.height = window.innerHeight + 'px'
		}
	}

	const handleHomeContentHeight = () => {
		setHomeHeight()
		window.addEventListener('resize', setHomeHeight)
	}

	const handleHeaderNavigationState = () => {
		const header = document.getElementById('header')
		if (!header) return

		const updateHeader = () => {
			if (header.dataset.stateChange === 'disabled') return

			if (window.scrollY > header.offsetHeight) {
				header.classList.add('navbar-sm')
			} else {
				header.classList.remove('navbar-sm')
			}
		}

		window.addEventListener('scroll', updateHeader)
		updateHeader()
	}

	const commaNumber = value =>
		value.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1,')

	const handlePageContainerShow = () => {
		const container = document.getElementById('page-container')
		if (container) container.classList.add('show')
	}

	const handlePageScrollContentAnimation = () => {
		const targets = document.querySelectorAll('[data-scrollview="true"]')

		const io = new IntersectionObserver(entries => {
			entries.forEach(entry => {
				if (!entry.isIntersecting) return

				const root = entry.target
				const animatedList = root.querySelectorAll('[data-animation=true]')

				animatedList.forEach(el => {
					const type = el.getAttribute('data-animation-type')

					if (el.classList.contains('contentAnimated')) return

					if (type === 'number') {
						let finalNum = parseInt(el.dataset.finalNumber)
						let current = 0
						let step = finalNum / 60

						const tick = () => {
							current += step
							if (current >= finalNum) current = finalNum
							el.textContent = commaNumber(Math.ceil(current))

							if (current < finalNum) requestAnimationFrame(tick)
						}
						requestAnimationFrame(tick)
					} else {
						el.classList.add(type, 'contentAnimated')
						setTimeout(() => el.classList.add('finishAnimated'), 1500)
					}
				})
			})
		}, { threshold: 0.3 })

		targets.forEach(t => io.observe(t))
	}

	const handleScrollToAction = () => {
		document.addEventListener('click', e => {
			const target = e.target.closest('[data-click=scroll-to-target]')
			if (!target) return

			e.preventDefault()

			const selector = target.dataset.scrollTarget || target.getAttribute('href')
			const targetEl = document.querySelector(selector)
			if (!targetEl) return

			const headerHeight = 50
			const y = targetEl.offsetTop - headerHeight

			window.scrollTo({ top: y, behavior: 'smooth' })
		})
	}

	const handleTooltip = () => {
		// Bootstrap tooltip 자동 활성화 (Vue + BS5)
		const tooltipElements = document.querySelectorAll('[data-bs-toggle=tooltip]')
		tooltipElements.forEach(el => {
			new bootstrap.Tooltip(el)
		})
	}

	const getCssVariable = variable => {
		return getComputedStyle(document.body).getPropertyValue(variable).trim()
	}

	const initVariables = () => {
		return {
			theme: getCssVariable('--app-theme'),
			componentColor: getCssVariable('--app-component-color'),
			componentBg: getCssVariable('--app-component-bg')
		}
	}

	onMounted(() => {
		handleHomeContentHeight()
		handleHeaderNavigationState()
		handlePageContainerShow()
		handlePageScrollContentAnimation()
		handleScrollToAction()
		handleTooltip()
		initVariables()
	})
}
